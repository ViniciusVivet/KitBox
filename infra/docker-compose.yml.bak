name: kitbox

services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.5
    command: ["start-dev", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_RELATIVE_PATH: /auth
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/realm-export:/opt/keycloak/data/import
    depends_on:
      - mongo

  api:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    working_dir: /src
    command: ["dotnet","run","--project","backend/src/KitBox.Api/KitBox.Api.csproj"]
    volumes:
      - ../:/src
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5238
      ASPNETCORE_ENVIRONMENT: Development
      Jwt__Authority: http://keycloak:8080/auth/realms/kitbox
      Jwt__Audience: kitbox-api
      ConnectionStrings__Mongo: mongodb://mongo:27017
      Mongo__Database: kitbox
    expose:
      - "5238"
    depends_on:
      - keycloak
      - mongo

  web:
    image: node:20
    working_dir: /app
    command: ["bash","-lc","npm install && npm run dev -- -p 3000"]
    volumes:
      - ../frontend:/app
    environment:
      NEXT_PUBLIC_KEYCLOAK_URL: http://localhost/auth
      NEXT_PUBLIC_KEYCLOAK_REALM: kitbox
      NEXT_PUBLIC_KEYCLOAK_CLIENT_ID: kitbox-web
      NEXT_PUBLIC_API_BASE: http://localhost/api
    expose:
      - "3000"
    depends_on:
      - api
      - keycloak

  nginx:
    image: nginx:1.25
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
    depends_on:
      - web
      - api

volumes:
  mongo_data: